---
title: "EIH prediction using AI approaches"
author: "FÃ©lix Boudry"
date: "`r Sys.Date()`"
documentclass: article
classoption: oneside
lang: en-US
output:
  html_document:
    toc: yes
    number_section: yes
    fig_caption: yes
    keep_md: yes
params:
  raw_data_import:
    label: "Import multiple raw study files?"
    value: FALSE
    input: checkbox
  data:
    label: "Input dataset:"
    value: none
    input: file
  data_list:
    label: "List of files to import:"
    value: none
    input: text
  data_folder:
    label: "Path to multiple data sets folder:"
    value: "./Data"
    input: text
  na_strings:
    label: "Strings to consider as \"NA\""
    value: c("", " ", "na", "NA")
    input: text
  new_LGBM_params:
    label: "Tune hyperparameters?"
    value: TRUE
    input: checkbox
  scale_data:
    label: "Scale data?"
    value: TRUE
    input: checkbox
  combine_plots:
    label: "Combine plots by condition?"
    value: FALSE
    input: checkbox
  cluster_number:
    label: "Numbers of clusters to compute:"
    value: c(2, 4)
    input: text
  cluste_number_names:
    label: "Names of the clusters:"
    value: c("two", "four")
    input: text
  dbscan_eps:
    label: "eps for DBSCAN clustering:"
    value: 10
    input: numeric
  dbscan_minPts:
    label: "Minimum number of points to create a cluster (DBSCAN):"
    value: 3
    input: numeric
  optics_eps:
    label: "eps for OPTICS clustering:"
    value: 250
    input: numeric
  optics_minPts:
    label: "Minimum number of points to create a cluster (OPTICS):"
    value: 5
    input: numeric
  optics_xi:
    label: "xi to compute clusters (OPTICS):"
    value: 0.1
    input: numeric
  lgbm_rounds:
    label: "Number of rounds for LGBM training:"
    value: 5000
    input: numeric
  lgbm_split:
    label: "Percentage of data used to train LGBM:"
    value: 0.75
    input: numeric
  classification_threshold:
    label: "Threshold for binary classification:"
    value: 0.5
    input: numeric
  optuna_rounds:
    label: "Number of rounds for LGBM training (Optuna tunning):"
    value: 150
    input: numeric
  optuna_trials:
    label: "Number of trials for hyperparameters tunning (Optuna):"
    value: 2000
    input: numeric
  discriminating_variables:
    label: "Variables to predict and/or to exclude from clustering and training:"
    value: c("saturation_rest", "saturation_end", "saturation_delta")
    input: text
bibliography: EIH_modeling.bib
---

```{r Setup, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  error = TRUE,
  message = FALSE,
  warning = FALSE
)

set.seed(seed = 123)

# Import libraries
source("./Scripts/Functions.R")
library(data.table)
library(tidyverse)
library(factoextra)
library(dbscan)
library(clusplus)
library(caret)
library(gbm)
library(lightgbm)
library(reticulate)
library(shapviz)
library(DiagrammeR)
library(magrittr)
library(gridExtra)
library(psych)
library(missRanger)
library(fs)
library(tcltk)
library(fossil)
library(tools)

# Create a folder to save results
analysis_date <- format(Sys.time(), "%Y-%m-%d_%H.%M.%S")
dir_create(path = paste0("Output/", analysis_date))

# Parameters for the analysis
## Parameters used in python script needs to be directly in .GlobalEnv
optuna_rounds <- params$optuna_rounds
optuna_trials <- params$optuna_trials
## Parsing and evaluating strings used as parameters to be used as code
cluster_number <-
  get_knit_param(params$cluster_number)
cluster_number_names <-
  get_knit_param(params$cluste_number_names)
discriminating_variables <-
  get_knit_param(params$discriminating_variables)
my_na_strings <- get_knit_param(params$na_strings)
```

```{r Import & scripts, message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
# Import raw data and transform to summaries if chosen or no data exists
if (params$raw_data_import |
    !dir_exists("./Data") |
    length(list.files(path = "./Data/")) < 1) {
  import_data()
}

# Import selected dataset
if (params$data != "none") {
  imported_data_names <-
    basename(params$data) %>%
    file_path_sans_ext()
  imported_data <-
    params$data %>%
    fread(na.strings = my_na_strings) %>%
    lst() %>%
    `names<-`(value = imported_data_names)
} else if (params$data_list != "none") {
  imported_data_names <-
    params$data_list %>%
    get_knit_param() %>% 
    basename() %>%
    file_path_sans_ext()
  imported_data <-
    lapply(
      X = params$data_list %>%
        get_knit_param(),
      FUN = fread,
      na.strings = my_na_strings
    ) %>%
    `names<-`(value = imported_data_names)
} else {
  imported_data_names <-
    params$data_folder %>%
    list.files() %>%
    file_path_sans_ext()
  imported_data <-
    list.files(path = params$data_folder,
               full.names = TRUE) %>%
    lapply(fread, na.strings = my_na_strings) %>%
    `names<-`(value = imported_data_names)
}

# Create environments (one per dataset, used for results storage)
my_envs <- lapply(X = imported_data_names, FUN = \(df_name) {
  my_name <- df_name
  df_name <- paste0(df_name, "_env") %>%
    assign(value = new.env())
  assign(x = "name", value = my_name, envir = df_name)
  return(df_name)
}) %>%
  `names<-`(value = imported_data_names)

# Source scripts for analysis
for (df_name in imported_data_names) {
  analysis_data <- imported_data[[df_name]]
  compute_env <- my_envs[[df_name]]
  source("./Scripts/Unsupervised.R", local = compute_env)
  source("./Scripts/Supervised.R", local = compute_env)
}
```

# Introduction

It is well known that endurance performances are limited by physiological
factors among which the cardio-respiratory is one of the most important
(@amannConvectiveOxygenTransport2008, @bassettLimitingFactorsMaximum2000). This
system can be limiting through different ways including the limitations of the
cardiac output (Qc), the oxygen diffusion or the pulmonary perfusion. Those
limitations can be enhanced by physical training and physiological adaptations
to exercise. Thus with training we can observe an increased cardiac output,
pulmonary perfusion or oxygen diffusion through an increased hemoglobin
concentration.

It's also well known that the environment can impact the oxygen pressures and
thus the inspired volume. This limitation is also present during
experimentation, like simulated altitude, during which the inspired fraction of
oxygen is diminished.

If the cardiac system is one of the most known limiting, the pulmonary system
can also participated in the observed limitations. This system is complicated
and the pulmonary anatomy is composed by several "section". A known
physiopathology impact athlete's performances is the exercise-induces hypoxemia
(EIH) (@raberinHypoxemieInduiteExercice2019). The purpose of this work is to be
able to classify athletes as EIH or NEIH without using the direct indicator
(saturation).

```{r Results, echo=FALSE, results='asis'}
for (my_env in my_envs) {
  cat(knitr::knit_child('Result_template.Rmd', envir = my_env, quiet = TRUE))
}
```

# Knitting parameters
```{r Infos}
params
```

# References

<div id="refs"></div>

```{r End_tasks, include=FALSE}
result_save()
```
