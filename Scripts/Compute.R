# Informations ------------------------------------------------------------
# Title: Compute.R
# Author: FÃ©lix Boudry
# Contact: <felix.boudry@univ-perp.fr>
# License: Private
# Description: Compute needed data and format them

# Configuration -----------------------------------------------------------

## Libraries --------------------------------------------------------------
## List of used libraries.
require(tidyverse)
require(CatEncoders)
require(FactoMineR)

# Environment -------------------------------------------------------------
# Load environment generated by previous script
rm(list = setdiff(x = ls(), y = lsf.str())) # Clean environment
load(file = "./Environments/import.RData") # Load environment

# Select columns ----------------------------------------------------------
# Select only columns present in all data frames
my_data$all <- lapply(X = my_data$all, FUN = colnames) %>%
  Reduce(f = intersect) %>%
  lapply(X = my_data$all, FUN = "[", .)

# Clean data --------------------------------------------------------------
# remove NA only rows an doutliers
my_data$all <-
  lapply(
    X = my_data$all,
    FUN = function(my_dataframe)
      filter(.data = my_dataframe,
             rowSums(x = is.na(x = my_dataframe)) != ncol(x = my_dataframe))
  ) %>%
  remove_outliers()

# Summary absolute --------------------------------------------------------
# Summarizing all data frames into one
my_summary <- mapply(
  FUN = function(df_input, name_input)
    dplyr::summarise(df_input, across(
      # Compute .fns for each column
      .cols = everything(),
      # Columns to compute
      .fns = list(
        # Functions to apply on columns
        mean = mean,
        max = max,
        min = min,
        median = median
      ),
      na.rm = TRUE
    )) %>%
    cbind("subject" = name_input),
  df_input = my_data$all,
  name_input = names(my_data$all)
) %>%
  t() %>%
  as.data.frame() %>%
  unnest(cols = colnames(x = .)) %>%
  merge(y = my_data$infos, by = "subject", all = TRUE)

# Summary relative --------------------------------------------------------
# Transform mean and min columns to relatives max values
my_summary_relative <- my_summary %>% # Copy summary
  compute_relative()

# PCA ---------------------------------------------------------------------
# Compute a PCA summary for analyzed data
PCA_data <- lapply(my_data$all, PCA, graph = FALSE)
PCA_summary <-
  data.frame(matrix(nrow = 0, ncol = length(PCA_data[[1]][[1]][, 1])))
for (my_data_frame in PCA_data) {
  PCA_summary <- rbind(PCA_summary, my_data_frame[[1]][, 1])
}
PCA_summary <- cbind(PCA_summary, my_data$infos$subject)
colnames(PCA_summary) <- c((colnames(my_data$all[[1]])), "subject")

# Remove outliers (summaries) ---------------------------------------------
my_summaries <-
  list(select(my_summary, -c(subject)),
       select(my_summary_relative, -c(subject)),
       select(PCA_summary, -c(subject)))
# my_summaries <-
    # remove_outliers(my_summaries)
subject_list <- my_summary$subject
my_summary <-
  my_summaries[1] %>% as.data.frame() %>% cbind("subject" = subject_list)
my_summary_relative <-
  my_summaries[2] %>% as.data.frame() %>% cbind("subject" = subject_list)
PCA_summary <-
  my_summaries[3] %>% as.data.frame() %>% cbind("subject" = subject_list)

# Data structure ----------------------------------------------------------
# Structuring data in vectors
my_data <- # Append summary in "my_data"
  append(
    x = my_data,
    values = lst(
      my_summary,
      my_summary_relative,
      # my_labels,
      # my_label_env_sex,
      # my_label_env_sport,
      PCA_data,
      PCA_summary
    )
  ) %>%
  `names<-`(
    c(
      names(x = my_data),
      "summary",
      "summary_relative",
      # "labels",
      # "label_env_sex",
      # "label_env_sport",
      "PCA",
      "PCA_summary"
    )
  )

# Remove variables not containing "my_data" & my_data_frame
rm(list = setdiff(x = ls(), y = c(lsf.str(), ls(pattern = "my_data"))), my_data_frame)

# Export data -------------------------------------------------------------
# Save environment to avoid recomputing
save.image(file = "./Environments/compute.RData")
